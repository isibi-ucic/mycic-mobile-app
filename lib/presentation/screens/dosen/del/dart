import 'dart:io';
import 'dart:typed_data';
import 'package:flutter/material.dart';
import 'package:flutter/rendering.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_spinkit/flutter_spinkit.dart';
import 'package:image_gallery_saver/image_gallery_saver.dart';
import 'package:mycic_app/core/assets/assets.gen.dart';
import 'package:mycic_app/core/components/buttons.dart';
import 'package:mycic_app/core/constants/colors.dart';
import 'package:mycic_app/core/helper/ms_route.dart';
import 'package:mycic_app/features/bloc/dsn_kelas_pertemuan_detail/dsn_kelas_pertemuan_detail_bloc.dart';
import 'package:mycic_app/presentation/screens/dosen/template_page.dart';
import 'package:mycic_app/presentation/widgets/default_app_bar.dart';
// Impor package yang baru ditambahkan
import 'package:qr_flutter/qr_flutter.dart';
import 'package:screenshot/screenshot.dart';
import 'package:share_plus/share_plus.dart';
import 'package:path_provider/path_provider.dart';

class DetailPertemuanPage extends StatefulWidget {
  final int pertemuanId;
  const DetailPertemuanPage({super.key, required this.pertemuanId});

  @override
  State<DetailPertemuanPage> createState() => _DetailPertemuanPageState();
}

class _DetailPertemuanPageState extends State<DetailPertemuanPage> {
  // 1. Buat ScreenshotController dan GlobalKey
  final ScreenshotController _screenshotController = ScreenshotController();
  final GlobalKey _qrKey = GlobalKey();

  @override
  void initState() {
    super.initState();
    _loadData();
  }

  Future<void> _loadData() async {
    context.read<DsnKelasPertemuanDetailBloc>().add(
      DsnKelasPertemuanDetailEvent.fetch(widget.pertemuanId),
    );
  }

  // 2. Perbaiki fungsi untuk Share QR Code
  Future<void> _shareQrCode() async {
    try {
      // Ganti captureFromLongWidget menjadi capture()
      final Uint8List? imageBytes = await _screenshotController.capture();

      if (imageBytes != null) {
        final directory = await getTemporaryDirectory();
        final imagePath =
            await File('${directory.path}/qr_presensi.png').create();
        await imagePath.writeAsBytes(imageBytes);

        await Share.shareXFiles([
          XFile(imagePath.path),
        ], text: 'Silakan pindai QR Code ini untuk presensi.');
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(
          context,
        ).showSnackBar(SnackBar(content: Text('Gagal membagikan QR Code: $e')));
      }
    }
  }

  // 3. Perbaiki fungsi untuk Download QR Code
  Future<void> _downloadQrCode() async {
    try {
      // Ganti captureFromLongWidget menjadi capture()
      final Uint8List? imageBytes = await _screenshotController.capture();

      if (imageBytes != null) {
        // Simpan langsung ke galeri dari memori
        await ImageGallerySaver.saveImage(
          imageBytes,
          name: "qr_presensi_${widget.pertemuanId}",
        );

        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('QR Code berhasil disimpan di galeri.'),
            ),
          );
        }
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(
          context,
        ).showSnackBar(SnackBar(content: Text('Gagal mengunduh QR Code: $e')));
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: const DefaultAppBar(title: 'Detail Pertemuan'),
      backgroundColor: AppColors.bgDefault,
      body: RefreshIndicator(
        onRefresh: _loadData,
        child: SingleChildScrollView(
          physics: const AlwaysScrollableScrollPhysics(),
          child: Padding(
            padding: const EdgeInsets.symmetric(vertical: 20, horizontal: 16),
            child: BlocBuilder<
              DsnKelasPertemuanDetailBloc,
              DsnKelasPertemuanDetailState
            >(
              builder: (context, state) {
                return state.maybeWhen(
                  orElse:
                      () => const Center(child: CircularProgressIndicator()),
                  loading:
                      () => const Center(
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            SpinKitThreeBounce(
                              color: Colors.blueAccent,
                              size: 20.0,
                            ),
                            Text("Loading..."),
                          ],
                        ),
                      ),
                  success: (response) {
                    return Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // ... (Widget Text, Wrap, dan PDF View tetap sama)
                        if (response.data.qrPresensi != null) ...[
                          // 4. Ganti gambar statis dengan QrImageView
                          Screenshot(
                            controller: _screenshotController,
                            child: Container(
                              // Bungkus dengan Container putih agar background tidak transparan
                              color: Colors.white,
                              child: Center(
                                child: QrImageView(
                                  key: _qrKey,
                                  data: response.data.qrPresensi!,
                                  version: QrVersions.auto,
                                  size: MediaQuery.of(context).size.width / 1.5,
                                  gapless: false,
                                ),
                              ),
                            ),
                          ),
                          const SizedBox(height: 16),
                          Column(
                            children: [
                              Row(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  // 5. Hubungkan fungsi ke tombol Download
                                  GestureDetector(
                                    onTap: _downloadQrCode,
                                    child: Padding(
                                      padding: const EdgeInsets.all(12.0),
                                      child: Row(
                                        children: [
                                          Assets.icons.download.svg(
                                            colorFilter: const ColorFilter.mode(
                                              AppColors.grey,
                                              BlendMode.srcIn,
                                            ),
                                          ),
                                          const SizedBox(width: 8),
                                          const Text("Download"),
                                        ],
                                      ),
                                    ),
                                  ),
                                  const SizedBox(width: 12),
                                  // 6. Hubungkan fungsi ke tombol Share
                                  GestureDetector(
                                    onTap: _shareQrCode,
                                    child: Padding(
                                      padding: const EdgeInsets.all(12.0),
                                      child: Row(
                                        children: [
                                          Assets.icons.share.svg(
                                            colorFilter: const ColorFilter.mode(
                                              AppColors.grey,
                                              BlendMode.srcIn,
                                            ),
                                          ),
                                          const SizedBox(width: 8),
                                          const Text("Share"),
                                        ],
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 24),
                            ],
                          ),
                        ],
                        if (response.data.qrPresensi == null) ...[
                          Button.filled(
                            label: "Buat QR Presensi",
                            color: AppColors.primary,
                            onPressed: () {
                              // TODO: Navigasi ke halaman pembuatan QR
                              msRoute(context, const TemplateDosenPage());
                            },
                            height: 45,
                            fontSize: 16,
                          ),
                        ],
                      ],
                    );
                  },
                );
              },
            ),
          ),
        ),
      ),
    );
  }
}
